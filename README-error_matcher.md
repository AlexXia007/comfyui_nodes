# ComfyUI Error Matcher Plugin

错误匹配节点，用于根据配置的错误规则匹配文本并返回错误信息或触发系统报错。

**版本**: v1.0

## 功能特性

### 文本匹配
- 支持最多3个文本输入源的错误检测
- 支持自定义错误规则配置
- 支持精确匹配和模糊匹配（关键词匹配）
- 支持触发ComfyUI系统报错

### 错误规则配置
- 每行格式：`"接收文本":"错误代码":"错误信息"`
- 支持多行规则配置
- 精确匹配：文本必须完全相同
- 模糊匹配：关键词出现在文本中即可

## 安装

1. 将本插件放入 ComfyUI 的 `custom_nodes` 目录
2. 安装依赖：
```bash
pip install -r requirements.txt
```
3. 重启 ComfyUI

## 使用说明

### 输入参数

#### 主要输入（必填）
- **input_text1** (STRING): 要检测的文本内容1
  - 默认值：`""`（空）
  - 支持多行文本
- **input_text2** (STRING): 要检测的文本内容2
  - 默认值：`""`（空）
  - 支持多行文本
- **input_text3** (STRING): 要检测的文本内容3
  - 默认值：`""`（空）
  - 支持多行文本

> **注意**：即使不需要检测3个文本源，也至少需要填写1个文本输入。如果所有输入都为空，且未配置错误规则，将返回"无错误"；如果配置了错误规则，可能会触发"无输入信息"错误。

#### 可选参数
- **error_rules** (STRING): 错误匹配规则配置（多行）
  - 默认值：`""`（空）
  - 不配置则始终返回"无错误"
  - 每行格式：`"接收文本":"错误代码":"错误信息"`
  - 示例：
  ```
  "错误啦":"404":"系统出错，请重试"
  "超时":"500":"请求超时，请稍后再试"
  "未授权":"401":"权限不足，无法访问"
  ```
  - Tooltip：错误匹配规则，每行格式："接收文本":"错误代码":"错误信息"
    例如："错误啦":"404":"系统出错，请重试"

- **fuzzy_match** (BOOLEAN): 是否开启模糊匹配
  - 默认值：`False`（关闭）
  - `False`：精确匹配，文本必须完全相同
  - `True`：模糊匹配，关键词出现在文本中即可
  - Tooltip：开启后使用模糊匹配（关键词匹配）

- **system_error** (BOOLEAN): 是否触发系统报错
  - 默认值：`True`（开启）
  - `True`：当匹配到错误规则时，抛出异常并触发ComfyUI系统报错界面
  - `False`：仅返回错误信息，不触发系统报错
  - Tooltip：开启后使用ComfyUI系统报错，关闭则仅输出错误信息

### 输出结果

节点返回2个值：
1. **error_code** (STRING): 错误代码
   - `"0"`：无错误
   - 其他：自定义错误代码
2. **error_message** (STRING): 错误信息
   - 成功时：`"无错误"`
   - 失败时：自定义错误信息

### 自定义错误码说明

错误代码由用户自定义配置，节点会根据匹配的规则返回对应的错误代码和信息。常见错误代码示例：

| 错误码 | 说明 | 示例场景 |
|--------|------|----------|
| 200 | 成功（通用） | 操作成功 |
| 400 | 请求错误 | 参数错误、格式错误 |
| 401 | 未授权 | 权限不足、认证失败 |
| 403 | 禁止访问 | 无权限、IP限制 |
| 404 | 未找到 | 资源不存在、路径错误 |
| 500 | 服务器错误 | 系统错误、超时 |
| 503 | 服务不可用 | 服务维护、过载 |

## 错误规则配置格式

### 基本格式

每行规则必须严格按照以下格式：
```
"接收文本":"错误代码":"错误信息"
```

### 格式要求

1. **使用双引号**：所有字段必须用双引号包裹
2. **使用冒号分隔**：三个字段之间使用冒号分隔
3. **一行一个规则**：多个规则需要换行配置
4. **可包含空格**：冒号前后可以有空格，会自动处理

### 配置示例

#### 示例1：基础错误检测
```
"错误啦":"404":"系统出错，请重试"
"超时":"500":"请求超时，请稍后再试"
"未授权":"401":"权限不足，无法访问"
```

#### 示例2：中文错误信息
```
"连接失败":"ERR_001":"网络连接失败，请检查网络设置"
"数据格式错误":"ERR_002":"输入的数据格式不正确"
"服务器异常":"ERR_003":"服务器发生异常，请联系管理员"
```

#### 示例3：多行配置
```
"404":"404":"页面未找到"
"500":"500":"服务器内部错误"
"Timeout":"500":"请求超时"
```

## 使用示例

### 示例1：检测API响应错误

**场景**：检测API返回的错误消息并触发相应错误码

**配置**：
```
error_rules:
"Unauthorized":"401":"未授权访问"
"Forbidden":"403":"禁止访问"
"Not Found":"404":"资源未找到"
"Internal Error":"500":"服务器内部错误"

fuzzy_match: False
system_error: True

input_text1: (从其他节点获取API响应)
```

**输出**：
- 如果匹配到 "Forbidden"，将抛出错误并停止执行
- 错误码：`401`、`403`、`404` 或 `500`
- 错误信息：对应的错误描述

### 示例2：关键词模糊匹配

**场景**：检测文本中是否包含关键词，不要求精确匹配

**配置**：
```
error_rules:
"错误":"ERROR":"检测到错误关键词"
"失败":"FAIL":"检测到失败信息"
"异常":"EXCEPTION":"检测到异常信息"

fuzzy_match: True
system_error: False

input_text1: "系统发生了一个严重的错误，请立即处理"
```

**输出**：
- error_code: `"ERROR"`
- error_message: `"检测到错误关键词"`

### 示例3：多文本源检测

**场景**：同时对多个文本源进行错误检测

**配置**：
```
error_rules:
"超时":"TIMEOUT":"请求超时"
"网络错误":"NETWORK":"网络连接失败"

fuzzy_match: True
system_error: True

input_text1: "服务器响应超时，请重试"
input_text2: "一切正常"
input_text3: "数据库连接网络错误"
```

**行为**：
1. input_text1 匹配到"超时"，触发错误并停止
2. 返回错误码：`TIMEOUT`
3. 即使 input_text3 也有错误，但由于 input_text1 已经触发，不会继续检测

### 示例4：仅返回错误信息（不触发系统报错）

**场景**：需要记录错误信息但不中断流程

**配置**：
```
error_rules:
"错误":"100":"发生了错误"

fuzzy_match: True
system_error: False

input_text1: "检测到错误信息"
```

**输出**：
- error_code: `"100"`
- error_message: `"发生了错误"`
- 不会触发系统报错，可以继续执行后续节点

## 匹配逻辑

### 精确匹配模式（fuzzy_match=False）

- 文本必须与规则中的"接收文本"**完全相同**
- 区分大小写
- 空格敏感

**示例**：
- 规则：`"错误"` → 输入 `"错误"` ✓ 匹配；输入 `"错误信息"` ✗ 不匹配；输入 `"发生了错误"` ✗ 不匹配

### 模糊匹配模式（fuzzy_match=True）

- 只要"接收文本"在输入文本中**出现**即可匹配
- 不区分位置（开头、中间、结尾都可以）
- 可以作为任意长度的子串

**示例**：
- 规则：`"错误"` → 输入 `"错误"` ✓ 匹配；输入 `"错误信息"` ✓ 匹配；输入 `"发生了错误"` ✓ 匹配；输入 `"这是一个错误"` ✓ 匹配

### 多文本源检测顺序

1. 按照 `input_text1` → `input_text2` → `input_text3` 的顺序检测
2. 匹配到第一个错误后立即停止
3. 触发系统报错（如果开启）并抛出异常
4. 如果未匹配到任何错误，返回 `("0", "无错误")`

## 特殊场景处理

### 1. 所有输入为空
- **有配置错误规则**：触发 `"404"` 错误，"无输入信息"
- **无配置错误规则**：返回 `"0"`，"无错误"

### 2. 空规则配置
- 不管输入什么，都返回 `"0"`，"无错误"

### 3. 规则格式错误
- 会抛出异常：`报错配置格式错误：每行应为 "接收文本":"错误代码":"错误信息"，例如："错误啦":"404":"系统出错，请重试"`

### 4. 匹配冲突
- 如果多个文本都匹配到不同规则，按检测顺序，第一个匹配的规则会被触发

## 技术实现

- 使用正则表达式解析双引号格式的错误规则
- 支持精确匹配和模糊匹配（关键词匹配）
- 自定义异常类 `ErrorMatcherError` 用于触发ComfyUI系统报错

## 注意事项

1. **输入文本为空**：如果三个输入都为空，会触发"无输入信息"错误（仅当配置了错误规则时）
2. **规则格式严格**：必须使用双引号包裹，使用冒号分隔，每行一个规则
3. **模糊匹配**：开启模糊匹配后，关键词只要出现在文本中即可匹配，不需要完全相等
4. **系统报错**：默认开启，匹配到错误时会抛出异常并中断执行；关闭后只会返回错误信息
5. **匹配顺序**：按照 input_text1、input_text2、input_text3 的顺序检测，匹配到第一个错误即停止
6. **错误码自定义**：错误代码由用户自定义，没有固定标准，可以是任意字符串（如 `"404"`、`"ERR_001"` 等）
7. **空规则**：如果不配置错误规则，则永远不会报错，始终返回无错误
8. **精确匹配**：默认精确匹配，文本必须完全相同才匹配；模糊匹配时，关键词作为子串匹配即可
9. **多行规则**：空行会被忽略，可以空行分隔规则以提高可读性
10. **错误信息**：支持中英文，长度无限制

## 与其他节点配合使用

### 常见使用场景

1. **API错误检测**：检测API返回的响应文本，识别错误并中断流程
2. **日志分析**：从日志文本中提取错误信息并触发相应处理
3. **文本校验**：校验文本内容是否符合预期，不符合则报错
4. **错误分类**：根据不同错误类型触发不同的处理逻辑（配合其他条件节点）

## 版本历史

- **v1.0** (当前版本)
  - 支持3个文本输入源
  - 支持自定义错误规则配置
  - 支持精确匹配和模糊匹配
  - 支持触发系统报错
  - 自定义异常类用于系统报错

