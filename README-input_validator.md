# ComfyUI Input Validator Plugin

输入限制校验节点，用于对用户输入的图片和提示词进行各种限制筛选。

**版本**: v2.1 - 新增系统报错功能，支持触发ComfyUI系统报错

## 功能特性

### 提示词验证
- 关键词黑名单检测（检测到任意禁止词即失败，分号分隔）
- 字符数限制（英文按0.5字符计算）
- 语种检测和限制

### 图片验证
1. URL中文字符编码转换
2. 图片数量限制
3. 图片总大小限制（KB）
4. 单图大小限制（KB）
5. 长边像素限制
6. 短边像素限制
7. 长短边比例限制
8. 宽高固定比例限制（如4:3,16:9）
9. 图片格式限制
10. 透明背景检测

### 系统报错功能
- **trigger_system_error**: 是否触发ComfyUI系统报错
  - 默认值：`false`（关闭）
  - 开启后，当输入触发限制时，会抛出异常并触发ComfyUI系统报错界面
  - 报错信息格式：`输入限制:status_code,error_message`

## 安装

1. 将本插件放入 ComfyUI 的 `custom_nodes` 目录
2. 安装依赖：
```bash
pip install -r requirements.txt
```
3. 重启 ComfyUI

## 使用说明

### 输入参数

#### 主要输入（至少输入一项）
- **prompt_text** (STRING, 可选): 提示词文本
- **image_urls** (STRING, 可选): 图片URL列表（每行一个）
  
> **注意**：`prompt_text` 和 `image_urls` 至少需要输入一个。如果输入了某个类型，节点会验证对应的类型；如果某个类型未输入，则不会验证该类型。

#### 限制参数（不填写则不检测）

**提示词限制：**
- **banned_words** (STRING): 禁止关键词列表（黑名单），分号(;)分隔，检测到任意词即失败
  - 默认值：`""`（空，不检测）
  - 示例：`"badword1;badword2"`
- **char_count_limit** (STRING): 字数限制，格式 `最小,最大`（整数）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"10,500"`
- **supported_languages** (STRING): 支持的语种，逗号(,)分隔
  - 默认值：`""`（空，不限制语种）
  - 示例：`"zh,en,ja,ko"`

**图片限制：**
- **url_encoding** (BOOLEAN): 是否对中文URL进行编码转换
  - 默认值：`True`（自动编码）
- **image_count_limit** (STRING): 图片数量限制，格式 `最小,最大`（整数）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"1,10"`
- **total_size_limit** (STRING): 图片总大小限制，格式 `最小,最大`（整数，单位KB）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"100,10240"`
- **single_size_limit** (STRING): 单图大小限制，格式 `最小,最大`（整数，单位KB）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"10,4096"`
- **long_edge_limit** (STRING): 长边像素限制，格式 `最小,最大`（整数，像素）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"10,3000"`
- **short_edge_limit** (STRING): 短边像素限制，格式 `最小,最大`（整数，像素）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"10,3000"`
- **aspect_ratio_limit** (STRING): 长短边比例限制，格式 `最小值,最大值`（小数）
  - 默认值：`"0,0"`（不限制）
  - 示例：`"0.1,0.9"`
- **fixed_ratios** (STRING): 固定宽高比限制，逗号分隔（字符串，冒号分隔）
  - 默认值：`"0:0"`（不限制）
  - 示例：`"4:3,16:9"`
- **image_formats** (STRING): 允许的图片格式，逗号分隔
  - 默认值：`""`（空，不限制格式）
  - 示例：`"jpg,png,webp"`
- **transparency_check** (SELECT): 透明背景检测选项
  - `disabled`: 不检测（默认）
  - `only_transparent`: 必须是透明背景
  - `no_transparent`: 不允许透明背景
- **trigger_system_error** (BOOLEAN): 是否触发ComfyUI系统报错
  - 默认值：`false`（关闭）
  - 开启后，当输入触发限制时，会抛出异常并触发ComfyUI系统报错界面

### 输出结果

节点返回7个值：
1. **status_code** (STRING): 状态码（见下方错误码说明）
2. **status** (STRING): 状态文本（success/error）
3. **error_message** (STRING): 错误信息（成功时为空）
4. **image_urls** (STRING): 处理后的图片URL列表（如果输入了图片）
5. **prompt_text** (STRING): 提示词文本（如果输入了提示词）
6. **prompt_status** (STRING): 提示词验证状态
   - `success`: 验证通过
   - `failed`: 验证失败
   - `no_input`: 未输入
7. **image_status** (STRING): 图片验证状态
   - `success`: 验证通过
   - `failed`: 验证失败
   - `no_input`: 未输入

## 错误码说明

| 错误码 | 说明 | 示例 |
|--------|------|------|
| 200 | 验证成功 | - |
| 400 | 缺少输入 | 至少需要输入 prompt_text 或 image_urls 中的一项 |
| 301 | 关键词验证失败 | 提示词验证未通过，包含限制词汇：xxx |
| 302 | 字数不足 | 当前10字符，最少需要20字符 |
| 303 | 字数超限 | 当前500字符，最多允许400字符 |
| 304 | 语种不符合 | 检测到：ja，支持：zh,en |
| 401 | 图片数量不足 | 当前2张，最少需要5张 |
| 402 | 图片数量超限 | 当前20张，最多允许10张 |
| 403 | 图片总大小不足 | 当前100KB，最少需要500KB |
| 404 | 图片总大小超限 | 当前20000KB，最多允许10240KB |
| 405 | 单图大小不足 | 当前50KB，最少需要100KB |
| 406 | 单图大小超限 | 当前10000KB，最多允许4096KB |
| 407 | 长边像素不足 | 当前800px，最少需要1024px |
| 408 | 长边像素超限 | 当前4000px，最多允许3000px |
| 409 | 短边像素不足 | 当前400px，最少需要512px |
| 410 | 短边像素超限 | 当前2000px，最多允许1500px |
| 411 | 长短边比例不足 | 当前0.33，最少需要0.5 |
| 412 | 长短边比例超限 | 当前0.9，最多允许0.75 |
| 413 | 宽高比例不符合 | 当前1920:1080(约1.78)，要求：4:3 |
| 414 | 图片格式不支持 | 当前bmp，支持：jpg,png |
| 415 | 透明背景不符合 | 必须为透明背景 或 不允许透明背景 |
| 416 | 图片读取失败 | 网络错误或格式错误 |
| 417 | 配置错误 | 参数格式错误或无法解析 |
| 418 | 图片URL无效 | 未检测到有效的图片URL |

## 数据类型说明

### 输入数据类型
- **整数类型**：`char_count_limit`、`image_count_limit`、`total_size_limit`、`single_size_limit`、`long_edge_limit`、`short_edge_limit`（使用`map(int, ...)`解析）
- **小数类型**：`aspect_ratio_limit`（使用`map(float, ...)`解析）
- **字符串类型**：`banned_words`、`supported_languages`、`fixed_ratios`、`image_formats`（字符串格式，内部解析）

### 特殊格式
- `fixed_ratios`: 使用冒号分隔比例，如 `4:3,16:9,21:9`
- `aspect_ratio_limit`: 小数格式，如 `0.1,0.9`
- 所有其他限制：整数格式（即使是KB大小也用整数）

## 使用示例

### 示例1：基础验证
```
prompt_text: "一只可爱的小猫在花园里玩耍"
image_urls: 
https://example.com/image1.jpg
https://example.com/image2.jpg
banned_words: "badword1;badword2"  # 禁止词汇黑名单
char_count_limit: "1,500"  # 1-500字符
image_count_limit: "2,5"  # 2-5张图片
image_formats: "jpg,png,webp"  # 只允许这些格式
```

### 示例2：严格限制
```
image_count_limit: "1,1"  # 只能1张图片
single_size_limit: "100,4096"  # 单图100KB-4MB
long_edge_limit: "1024,2048"  # 长边1024-2048像素
aspect_ratio_limit: "0.5,0.75"  # 长短边比例0.5-0.75
fixed_ratios: "4:3,16:9"  # 只允许4:3或16:9
transparency_check: "no_transparent"  # 不允许透明背景
trigger_system_error: True  # 触发系统报错
```

### 示例3：启用系统报错
```
trigger_system_error: True  # 开启系统报错
long_edge_limit: "1000,0"  # 长边至少1000像素
```
开启系统报错后，如果触发限制（如上例长边不足1000），会抛出异常：`输入限制:407,第1张图片：长边不足，当前512，最少需要1000`

## 验证步骤说明

节点按照以下步骤进行验证，步骤编号与代码注释对应：

### 提示词验证步骤
1. **关键词黑名单检测**（1）- 检测提示词中是否包含禁止词汇
2. **字数限制**（2）- 验证字符数是否符合要求
3. **语种检测**（3）- 检测提示词的语种是否符合要求

### 图片验证步骤
1. **URL编码转换**（4）- 对包含中文字符的URL进行编码
2. **图片数量验证**（5）- 验证图片数量是否在允许范围内
3. **图片信息获取**（6）- 下载并读取图片信息
4. **图片总大小验证**（7）- 验证所有图片的总大小
5. **单图验证**（8）- 对每张图片进行以下验证：
   - **8.1** 单图大小验证
   - **8.2** 长边和短边像素验证
   - **8.3** 长短边比例验证
   - **8.4** 固定宽高比验证
   - **8.5** 图片格式验证
   - **8.6** 透明背景验证

## 技术实现

- 使用 PIL (Pillow) 进行图片处理
- 使用 requests 进行图片下载
- 使用正则表达式进行语种检测
- 使用 urllib.parse 进行 URL 编码

## 注意事项

1. **禁止词汇验证**：banned_words 为黑名单模式，默认空（不检测），填写后检测到任意禁止词即失败
2. **图片格式**：image_formats 默认为空（不检测），填写后才检查图片格式
3. **默认值原则**：所有限制字段默认为"不限制"（0或空），只有填写了才会进行检测
4. **限制值说明**：所有"最小,最大"格式的限制，0表示"不限制"。例如 `1000,0` 表示最少1000，最多不限；`0,5000` 表示最少不限，最多5000
5. **系统报错功能**：trigger_system_error 开启后，触发限制时会抛出异常，ComfyUI会显示红色报错弹窗
6. 所有图片限制都会对每张图片单独验证
7. 透明背景检测基于图片的透明度通道
8. jpg 和 jpeg 被视为同一格式
9. URL中的中文字符会被自动编码转换
10. 英文按0.5字符计算，中文按1字符计算

